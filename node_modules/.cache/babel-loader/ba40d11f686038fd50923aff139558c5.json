{"ast":null,"code":"import _objectSpread from\"/Users/mvps/culturex/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"/Users/mvps/culturex/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import _regeneratorRuntime from\"/Users/mvps/culturex/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _toConsumableArray from\"/Users/mvps/culturex/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _asyncToGenerator from\"/Users/mvps/culturex/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import{atomFamily,selectorFamily,useRecoilState}from\"recoil\";import{sansPrefix}from\"@onflow/fcl\";import{IDLE,PROCESSING}from\"../global/constants\";import{useCurrentUser}from\"../hooks/use-current-user.hook\";import{useAccountItems}from\"../hooks/use-account-items.hook\";import{useMarketItems}from\"../hooks/use-market-items.hook\";import{useKibblesBalance}from\"../hooks/use-kibbles-balance.hook\";import{fetchMarketItem}from\"../flow/fetch-market-item.script\";import{buyMarketItem}from\"../flow/buy-market-item.tx\";import{cancelMarketListing}from\"../flow/cancel-market-listing.tx\";function expand(key){return key.split(\"|\");}function comp(address,id){return[address,id].join(\"|\");}export var $state=atomFamily({key:\"market-item::state\",default:selectorFamily({key:\"market-item::default\",get:function get(key){return/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",fetchMarketItem.apply(void 0,_toConsumableArray(expand(key))));case 1:case\"end\":return _context.stop();}}},_callee);}));}})});export var $status=atomFamily({key:\"market-item::status\",default:IDLE});export function useMarketItem(address,id){var _useCurrentUser=useCurrentUser(),_useCurrentUser2=_slicedToArray(_useCurrentUser,1),cu=_useCurrentUser2[0];var ownerItems=useAccountItems(address);var cuItems=useAccountItems(cu.addr);var ownerMarket=useMarketItems(address);var cuMarket=useMarketItems(cu.addr);var kibble=useKibblesBalance(cu.addr);var key=comp(address,id);var _useRecoilState=useRecoilState($state(key)),_useRecoilState2=_slicedToArray(_useRecoilState,2),item=_useRecoilState2[0],setItem=_useRecoilState2[1];var _useRecoilState3=useRecoilState($status(key)),_useRecoilState4=_slicedToArray(_useRecoilState3,2),status=_useRecoilState4[0],setStatus=_useRecoilState4[1];var owned=sansPrefix(cu.addr)===sansPrefix(address);return _objectSpread(_objectSpread({},item),{},{status:status,owned:owned,buy:function buy(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:_context4.next=2;return buyMarketItem({itemId:id,ownerAddress:address},{onStart:function onStart(){setStatus(PROCESSING);},onSuccess:function onSuccess(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(address!==cu.addr){ownerItems.refresh();ownerMarket.refresh();}cuItems.refresh();cuMarket.refresh();kibble.refresh();case 4:case\"end\":return _context2.stop();}}},_callee2);}))();},onComplete:function onComplete(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:setStatus(IDLE);case 1:case\"end\":return _context3.stop();}}},_callee3);}))();}});case 2:case\"end\":return _context4.stop();}}},_callee4);}))();},cancelListing:function cancelListing(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(){return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return cancelMarketListing({itemId:id},{onStart:function onStart(){setStatus(PROCESSING);},onSuccess:function onSuccess(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:cuItems.refresh();cuMarket.refresh();kibble.refresh();case 3:case\"end\":return _context5.stop();}}},_callee5);}))();},onComplete:function onComplete(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(){return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:setStatus(IDLE);case 1:case\"end\":return _context6.stop();}}},_callee6);}))();}});case 2:case\"end\":return _context7.stop();}}},_callee7);}))();},refresh:function refresh(){return _asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(){return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:setStatus(PROCESSING);_context8.next=3;return fetchMarketItem.apply(void 0,_toConsumableArray(expand(key))).then(setItem);case 3:setStatus(IDLE);case 4:case\"end\":return _context8.stop();}}},_callee8);}))();}});}","map":{"version":3,"sources":["/Users/mvps/culturex/web/src/hooks/use-market-item.hook.js"],"names":["atomFamily","selectorFamily","useRecoilState","sansPrefix","IDLE","PROCESSING","useCurrentUser","useAccountItems","useMarketItems","useKibblesBalance","fetchMarketItem","buyMarketItem","cancelMarketListing","expand","key","split","comp","address","id","join","$state","default","get","$status","useMarketItem","cu","ownerItems","cuItems","addr","ownerMarket","cuMarket","kibble","item","setItem","status","setStatus","owned","buy","itemId","ownerAddress","onStart","onSuccess","refresh","onComplete","cancelListing","then"],"mappings":"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","sourcesContent":["import {atomFamily, selectorFamily, useRecoilState} from \"recoil\"\nimport {sansPrefix} from \"@onflow/fcl\"\nimport {IDLE, PROCESSING} from \"../global/constants\"\nimport {useCurrentUser} from \"../hooks/use-current-user.hook\"\nimport {useAccountItems} from \"../hooks/use-account-items.hook\"\nimport {useMarketItems} from \"../hooks/use-market-items.hook\"\nimport {useKibblesBalance} from \"../hooks/use-kibbles-balance.hook\"\nimport {fetchMarketItem} from \"../flow/fetch-market-item.script\"\nimport {buyMarketItem} from \"../flow/buy-market-item.tx\"\nimport {cancelMarketListing} from \"../flow/cancel-market-listing.tx\"\n\nfunction expand(key) {\n  return key.split(\"|\")\n}\n\nfunction comp(address, id) {\n  return [address, id].join(\"|\")\n}\n\nexport const $state = atomFamily({\n  key: \"market-item::state\",\n  default: selectorFamily({\n    key: \"market-item::default\",\n    get: key => async () => fetchMarketItem(...expand(key)),\n  }),\n})\n\nexport const $status = atomFamily({\n  key: \"market-item::status\",\n  default: IDLE,\n})\n\nexport function useMarketItem(address, id) {\n  const [cu] = useCurrentUser()\n  const ownerItems = useAccountItems(address)\n  const cuItems = useAccountItems(cu.addr)\n  const ownerMarket = useMarketItems(address)\n  const cuMarket = useMarketItems(cu.addr)\n  const kibble = useKibblesBalance(cu.addr)\n  const key = comp(address, id)\n  const [item, setItem] = useRecoilState($state(key))\n  const [status, setStatus] = useRecoilState($status(key))\n\n  const owned = sansPrefix(cu.addr) === sansPrefix(address)\n\n  return {\n    ...item,\n    status,\n    owned,\n    async buy() {\n      await buyMarketItem(\n        {itemId: id, ownerAddress: address},\n        {\n          onStart() {\n            setStatus(PROCESSING)\n          },\n          async onSuccess() {\n            if (address !== cu.addr) {\n              ownerItems.refresh()\n              ownerMarket.refresh()\n            }\n            cuItems.refresh()\n            cuMarket.refresh()\n            kibble.refresh()\n          },\n          async onComplete() {\n            setStatus(IDLE)\n          },\n        }\n      )\n    },\n    async cancelListing() {\n      await cancelMarketListing(\n        {itemId: id},\n        {\n          onStart() {\n            setStatus(PROCESSING)\n          },\n          async onSuccess() {\n            cuItems.refresh()\n            cuMarket.refresh()\n            kibble.refresh()\n          },\n          async onComplete() {\n            setStatus(IDLE)\n          },\n        }\n      )\n    },\n    async refresh() {\n      setStatus(PROCESSING)\n      await fetchMarketItem(...expand(key)).then(setItem)\n      setStatus(IDLE)\n    },\n  }\n}\n"]},"metadata":{},"sourceType":"module"}