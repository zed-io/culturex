{"ast":null,"code":"import _toConsumableArray from\"/Users/mvps/culturex/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _defineProperty from\"/Users/mvps/culturex/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _objectSpread from\"/Users/mvps/culturex/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _regeneratorRuntime from\"/Users/mvps/culturex/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/mvps/culturex/web/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";var _HANDLERS;// TODO: MOVE TO @onflow/util-batch\nimport{spawn,send,INIT}from\"@onflow/util-actor\";import{uid}from\"@onflow/util-uid\";var TICK=500;var BUFFER_SIZE=10;var SET_CALLBACK=\"SET_CALLBACK\";var PROCESS=\"PROCESS\";var MAYBE_PROCESS=\"MAYBE_PROCESS\";var TIMEOUT=\"TIMEOUT\";var ENQUEUE=\"ENQUEUE\";var RESOLVE=\"RESOLVE\";var HANDLERS=(_HANDLERS={},_defineProperty(_HANDLERS,INIT,function(ctx){ctx.put(\"need\",new Set());ctx.put(\"processing\",new Set());ctx.put(\"hold\",{});setInterval(function(){return ctx.sendSelf(TIMEOUT);},TICK);}),_defineProperty(_HANDLERS,SET_CALLBACK,function(ctx,letter,callback){ctx.put(\"callback\",/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var _args=arguments;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",callback.apply(void 0,_args));case 1:case\"end\":return _context.stop();}}},_callee);})));ctx.sendSelf(MAYBE_PROCESS);}),_defineProperty(_HANDLERS,ENQUEUE,function(ctx,letter,args){var id=uid();var hold={id:id,args:args,reply:letter.reply};ctx.update(\"need\",function(n){n.add(id);return n;});ctx.update(\"hold\",function(h){return _objectSpread(_objectSpread({},h),{},_defineProperty({},id,hold));});ctx.sendSelf(MAYBE_PROCESS);}),_defineProperty(_HANDLERS,TIMEOUT,function(ctx){if(ctx.get(\"need\").size)ctx.sendSelf(PROCESS);}),_defineProperty(_HANDLERS,MAYBE_PROCESS,function(ctx){if(ctx.get(\"need\")>=BUFFER_SIZE)ctx.sendSelf(PROCESS);}),_defineProperty(_HANDLERS,PROCESS,function(ctx){var callback=ctx.get(\"callback\");if(typeof callback!==\"function\")return;var need=ctx.get(\"need\");ctx.update(\"processing\",function(p){return new Set([].concat(_toConsumableArray(p),_toConsumableArray(need)));});ctx.put(\"need\",new Set());var hold=ctx.get(\"hold\");var payload=_toConsumableArray(need).reduce(function(acc,key){return _objectSpread(_objectSpread({},acc),{},_defineProperty({},key,hold[key].args));},{});callback(payload).then(function(result){ctx.sendSelf(RESOLVE,result);});}),_defineProperty(_HANDLERS,RESOLVE,function(ctx,_,results){var have=Object.keys(results);var _loop=function _loop(){var h=_have[_i];var hold=ctx.get(\"hold\");hold[h].reply(results[h]);ctx.update(\"processing\",function(p){p.delete(h);return p;});ctx.update(\"hold\",function(hold){delete hold[h];return hold;});};for(var _i=0,_have=have;_i<_have.length;_i++){_loop();}}),_HANDLERS);export var batch=function batch(name,callback){spawn(HANDLERS,name);send(name,SET_CALLBACK,callback);return{enqueue:function enqueue(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}return send(name,ENQUEUE,args,{expectReply:true,timeout:0});}};};","map":{"version":3,"sources":["/Users/mvps/culturex/web/src/flow/util/batch.js"],"names":["spawn","send","INIT","uid","TICK","BUFFER_SIZE","SET_CALLBACK","PROCESS","MAYBE_PROCESS","TIMEOUT","ENQUEUE","RESOLVE","HANDLERS","ctx","put","Set","setInterval","sendSelf","letter","callback","args","id","hold","reply","update","n","add","h","get","size","need","p","payload","reduce","acc","key","then","result","_","results","have","Object","keys","delete","batch","name","enqueue","expectReply","timeout"],"mappings":"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","sourcesContent":["// TODO: MOVE TO @onflow/util-batch\nimport {spawn, send, INIT} from \"@onflow/util-actor\"\nimport {uid} from \"@onflow/util-uid\"\n\nconst TICK = 500\nconst BUFFER_SIZE = 10\n\nconst SET_CALLBACK = \"SET_CALLBACK\"\nconst PROCESS = \"PROCESS\"\nconst MAYBE_PROCESS = \"MAYBE_PROCESS\"\nconst TIMEOUT = \"TIMEOUT\"\nconst ENQUEUE = \"ENQUEUE\"\nconst RESOLVE = \"RESOLVE\"\n\nconst HANDLERS = {\n  [INIT]: ctx => {\n    ctx.put(\"need\", new Set())\n    ctx.put(\"processing\", new Set())\n    ctx.put(\"hold\", {})\n    setInterval(() => ctx.sendSelf(TIMEOUT), TICK)\n  },\n\n  [SET_CALLBACK]: (ctx, letter, callback) => {\n    ctx.put(\"callback\", async (...args) => callback(...args))\n    ctx.sendSelf(MAYBE_PROCESS)\n  },\n\n  [ENQUEUE]: (ctx, letter, args) => {\n    const id = uid()\n    const hold = {id, args, reply: letter.reply}\n    ctx.update(\"need\", n => {\n      n.add(id)\n      return n\n    })\n    ctx.update(\"hold\", h => ({...h, [id]: hold}))\n    ctx.sendSelf(MAYBE_PROCESS)\n  },\n\n  [TIMEOUT]: ctx => {\n    if (ctx.get(\"need\").size) ctx.sendSelf(PROCESS)\n  },\n\n  [MAYBE_PROCESS]: ctx => {\n    if (ctx.get(\"need\") >= BUFFER_SIZE) ctx.sendSelf(PROCESS)\n  },\n\n  [PROCESS]: ctx => {\n    const callback = ctx.get(\"callback\")\n    if (typeof callback !== \"function\") return\n\n    const need = ctx.get(\"need\")\n    ctx.update(\"processing\", p => new Set([...p, ...need]))\n    ctx.put(\"need\", new Set())\n\n    const hold = ctx.get(\"hold\")\n    const payload = [...need].reduce(\n      (acc, key) => ({...acc, [key]: hold[key].args}),\n      {}\n    )\n\n    callback(payload).then(result => {\n      ctx.sendSelf(RESOLVE, result)\n    })\n  },\n  [RESOLVE]: (ctx, _, results) => {\n    const have = Object.keys(results)\n    for (let h of have) {\n      const hold = ctx.get(\"hold\")\n      hold[h].reply(results[h])\n      ctx.update(\"processing\", p => {\n        p.delete(h)\n        return p\n      })\n      ctx.update(\"hold\", hold => {\n        delete hold[h]\n        return hold\n      })\n    }\n  },\n}\n\nexport const batch = (name, callback) => {\n  spawn(HANDLERS, name)\n  send(name, SET_CALLBACK, callback)\n\n  return {\n    enqueue(...args) {\n      return send(name, ENQUEUE, args, {expectReply: true, timeout: 0})\n    },\n  }\n}\n"]},"metadata":{},"sourceType":"module"}